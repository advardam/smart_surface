<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Surface Dashboard</title>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#fffef6;
      --card:#efff9a; /* pale lime */
      --accent:#d9ff6f; /* bright */
      --text-dark:#202020;
      --muted:#6b6b6b;
      --accent-dark:#b7d94a;
      --highlight:#f7a84b;
    }
    body{
      margin:0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg,#ffd89b30,#fff);
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
    }
    .wrap{
      width:95%;
      max-width:1100px;
      background:#ffffff;
      border-radius:18px;
      padding:22px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      border: 6px solid #fff;
    }
    .top{
      display:flex;
      gap:18px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }
    .title{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:72px;
      height:72px;
      background:linear-gradient(180deg,#dff97a,#bfe44a);
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#1a1a1a;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    .title h1{
      margin:0;
      font-size:20px;
      color:var(--text-dark);
    }
    .controls{
      display:flex;
      gap:12px;
      align-items:center;
    }
    button{
      background:linear-gradient(180deg,#f7d36b,#f0c24b);
      border: none;
      padding:12px 18px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,0.08);
      color:#111;
    }
    button:disabled{
      opacity:0.6; cursor:not-allowed;
    }

    .main{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }

    .card{
      background:var(--card);
      border-radius:12px;
      padding:16px;
      min-height:140px;
      box-shadow: inset 0 -6px 0 rgba(0,0,0,0.02);
    }
    .big{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      font-size:36px;
      font-weight:800;
      color:var(--text-dark);
      padding:24px;
    }

    .metrics{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-around;
      margin-bottom:8px;
    }
    .metric{
      text-align:center;
    }
    .metric .v{
      font-size:24px;
      font-weight:800;
      color:#153; /* greenish, but we'll override below */
    }

    /* small responsive */
    @media (max-width:820px){
      .main{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <div class="logo">SS</div>
        <div>
          <h1>Smart Surface & Shape Detector</h1>
          <div style="color:var(--muted);font-size:13px">Pi Dashboard</div>
        </div>
      </div>

      <div class="controls">
        <button id="btnDistance" onclick="doMeasure()">Check Distance</button>
        <button id="btnShape" onclick="doShape()">Check Shape</button>
      </div>
    </div>

    <div class="main">
      <!-- Large distance card -->
      <div class="card big" id="distanceCard">
        <div style="font-size:14px;color:#444">Distance Measured</div>
        <div id="distanceVal">-- cm</div>
        <div id="tempVal" style="font-size:13px;color:var(--muted);margin-top:8px">Temp: -- °C | Color: --</div>
      </div>

      <!-- Pie chart & small metrics -->
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <strong>Performance</strong>
          <div style="color:var(--muted);font-size:12px">Color / Shape / Temp</div>
        </div>
        <canvas id="pieChart" width="300" height="200"></canvas>
        <div class="metrics" style="margin-top:6px;">
          <div class="metric"><div style="font-size:12px;color:var(--muted)">Color Detected</div><div class="v" id="colorVal">--</div></div>
          <div class="metric"><div style="font-size:12px;color:var(--muted)">Shape Detected</div><div class="v" id="shapeVal">--</div></div>
          <div class="metric"><div style="font-size:12px;color:var(--muted)">Temperature</div><div class="v" id="tempSmall">--</div></div>
        </div>
      </div>

      <!-- Line chart: last 5 readings -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>Last 5 Distance Variation</strong>
          <div style="color:var(--muted);font-size:12px">(Shown after Check Shape)</div>
        </div>
        <canvas id="lineChart" width="400" height="200"></canvas>
      </div>

      <!-- Extra info / status -->
      <div class="card">
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div><strong>Status</strong></div>
          <div id="status" style="color:var(--muted)">Ready</div>
          <div style="margin-top:6px;"><small style="color:var(--muted)">Press "Check Distance" to get a single reading. Press "Check Shape" to take 5 readings and analyze shape (line chart will appear).</small></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Chart variables
  let pieChart = null;
  let lineChart = null;

  // Initial empty pie (3 equal slices)
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  pieChart = new Chart(pieCtx, {
    type: 'doughnut',
    data: {
      labels: ['Color','Shape','Temperature'],
      datasets: [{
        data: [33,33,34],
        backgroundColor: ['#f7d36b','#bfe44a','#ffd89b'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '55%',
      plugins: { legend: { position: 'bottom' } }
    }
  });

  // initial empty line
  const lineCtx = document.getElementById('lineChart').getContext('2d');
  lineChart = new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: ['1','2','3','4','5'],
      datasets: [{
        label: 'Distance (cm)',
        data: [0,0,0,0,0],
        fill: true,
        tension: 0.35,
        pointRadius: 6,
        backgroundColor: 'rgba(183,217,74,0.18)',
        borderColor: '#9bd55a'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // UI helpers
  function setStatus(msg, isError=false) {
    const s = document.getElementById('status');
    s.innerText = msg;
    s.style.color = isError ? '#cc3333' : '#666';
  }

  function disableBtns(v) {
    document.getElementById('btnDistance').disabled = v;
    document.getElementById('btnShape').disabled = v;
  }

  // endpoints
  async function doMeasure() {
    setStatus('Measuring...');
    disableBtns(true);
    try {
      const res = await fetch('/measure');
      if (!res.ok) throw new Error('Server error');
      const data = await res.json();
      document.getElementById('distanceVal').innerText = (data.distance >= 0 ? data.distance + ' cm' : '-- cm');
      document.getElementById('tempVal').innerText = 'Temp: ' + (data.temperature !== null ? data.temperature + ' °C' : '--') + ' | Color: ' + (data.color || '--');
      // update small metrics and pie
      updatePerformance(data);
      setStatus('Measurement complete');
    } catch (err) {
      setStatus('Error: ' + err.message, true);
    } finally {
      disableBtns(false);
    }
  }

  async function doShape() {
    setStatus('Taking 5 readings...');
    disableBtns(true);
    try {
      const res = await fetch('/check_shape');
      if (!res.ok) throw new Error('Server error');
      const d = await res.json();
      // update main distance (average)
      document.getElementById('distanceVal').innerText = d.average + ' cm';
      document.getElementById('shapeVal').innerText = d.shape || '--';
      document.getElementById('colorVal').innerText = d.color || '--';
      document.getElementById('tempSmall').innerText = d.temperature !== null ? d.temperature + ' °C' : '--';

      // update line chart with the 5 readings
      const readings = d.distances.map(v => Number(v));
      lineChart.data.datasets[0].data = readings;
      lineChart.update();

      // update pie chart with scores
      const sc = d.scores || {color:33,shape:33,temperature:34};
      pieChart.data.datasets[0].data = [sc.color, sc.shape, sc.temperature];
      pieChart.update();

      setStatus('Shape analysis complete: ' + (d.shape || 'Unknown'));
    } catch (err) {
      setStatus('Error: ' + err.message, true);
    } finally {
      disableBtns(false);
    }
  }

  function updatePerformance(data) {
    // small update to pie chart: prefer scores if present
    if (data.scores) {
      pieChart.data.datasets[0].data = [data.scores.color, data.scores.shape, data.scores.temperature];
      pieChart.update();
    } else {
      // fallback: mark available sensors as high
      const c = data.color ? 90 : 10;
      const s = 90;
      const t = data.temperature !== null ? 90 : 10;
      pieChart.data.datasets[0].data = [c,s,t];
      pieChart.update();
    }
  }
</script>
</body>
</html>
